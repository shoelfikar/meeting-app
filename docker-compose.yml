services:
  # Redis Cache & Pub/Sub
  redis:
    platform: linux/arm64
    image: redis:7-alpine
    container_name: ${REDIS_CONTAINER_NAME:-meet-redis}
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - server_network

  # Backend API
  backend:
    platform: linux/arm64
    build:
      context: ./meet-app-backend
      dockerfile: Dockerfile
      platforms:
        - linux/arm64
    container_name: ${BACKEND_CONTAINER_NAME:-meet-backend}
    restart: unless-stopped
    environment:
      # Server
      - PORT=${BACKEND_PORT}
      - GIN_MODE=${GIN_MODE}
      - ENVIRONMENT=${ENVIRONMENT}

      # Database
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_SSLMODE=${DB_SSLMODE}
      - DB_MAX_CONNECTIONS=${DB_MAX_CONNECTIONS}
      - DB_MAX_IDLE_CONNECTIONS=${DB_MAX_IDLE_CONNECTIONS}

      # Redis
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB}

      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRY=${JWT_EXPIRY}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY}

      # CORS
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - CORS_ALLOWED_METHODS=${CORS_ALLOWED_METHODS}
      - CORS_ALLOWED_HEADERS=${CORS_ALLOWED_HEADERS}

      # MinIO
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_USE_SSL=${MINIO_USE_SSL}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      - MINIO_REGION=${MINIO_REGION}

      # WebRTC
      - STUN_SERVER=${STUN_SERVER}

      # WebSocket
      - WS_READ_BUFFER_SIZE=${WS_READ_BUFFER_SIZE}
      - WS_WRITE_BUFFER_SIZE=${WS_WRITE_BUFFER_SIZE}
      - WS_MAX_MESSAGE_SIZE=${WS_MAX_MESSAGE_SIZE}

      # SSE
      - SSE_RETRY_TIMEOUT=${SSE_RETRY_TIMEOUT}
      - SSE_HEARTBEAT_INTERVAL=${SSE_HEARTBEAT_INTERVAL}

      # Rate Limiting
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_FORMAT=${LOG_FORMAT}

      # Meeting
      - MAX_PARTICIPANTS_PER_MEETING=${MAX_PARTICIPANTS_PER_MEETING}
      - MEETING_CODE_LENGTH=${MEETING_CODE_LENGTH}
      - DEFAULT_MEETING_DURATION=${DEFAULT_MEETING_DURATION}

      # File Upload
      - MAX_UPLOAD_SIZE=${MAX_UPLOAD_SIZE}
      - ALLOWED_FILE_TYPES=${ALLOWED_FILE_TYPES}
    ports:
      - "${BACKEND_PORT}:8080"
    networks:
      - server_network
    depends_on:
      redis:
        condition: service_started

  # Frontend
  frontend:
    platform: linux/arm64
    build:
      context: ./meet-app-frontend
      dockerfile: Dockerfile
      platforms:
        - linux/arm64
      args:
        - VITE_API_URL=${VITE_API_URL}
        - VITE_WS_URL=${VITE_WS_URL}
    container_name: ${FRONTEND_CONTAINER_NAME:-meet-frontend}
    restart: unless-stopped
    ports:
      - "3000:80"
    networks:
      - server_network
    depends_on:
      - backend

networks:
  server_network:
    external: true

volumes:
  redis_data:
    driver: local
